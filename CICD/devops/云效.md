# 云效
## 技术方案

### 执行机的安装与使用
* 云内ecs可以直接选择并添加到主机组自动安装runner，无需手动安装
* 云内ecs优先会使用内网访问，但是实际构建过程可能仍需开启公网
* 一个runnner可以跑多个任务，可配置允许的最大并发任务数。
* 支持日志自动清理、构建缓存LRU、容器清理、镜像清理

### 缓存
| 缓存类型 | 存储位置 | 共享范围 | 清理机制 | 大小限制/注意事项 |
| :--- | :--- | :--- | :--- | :--- |
| **任务级文件缓存** | 云端 OSS | 同一流水线的**同一任务**的不同执行实例之间 | 手动清除或**超过3个月未更新**自动清理 | 压缩后超过 **2GB** 不会上传 |
| **本地文件缓存** | 私有构建集群宿主机的特定目录 | 通过**目录挂载**实现**同一主机上多个任务**共享 | 提供清理工具，清理**15天未更新**的缓存目录 | 需定期清理，防止磁盘占满 |
| **镜像构建缓存 (公共集群)** | 云端（通过 BuildKit sidecar 容器） | 同一流水线的**同一任务**的不同执行实例之间 | 随缓存上下文一同上传至云端，下次构建恢复 | 缓存超过 **5GB** 不会上传 |
| **镜像构建缓存 (私有集群)** | **本地 Docker 守护进程** | 依赖于本地 Docker 缓存机制 | 本地 Docker 管理 | 无明确大小限制，但需关注本地磁盘空间 |
| **Registry 镜像缓存** | 指定的远端镜像仓库（如阿里云 ACR） | 所有能访问该镜像仓库的任务 | 手动管理或通过镜像仓库策略清理 | 无明确大小限制，但需关注镜像仓库的存储容量 |

### 安全
* 镜像防篡改：sha256完整性认证
* 镜像数字签名、可信镜像仓库
* 镜像扫描：漏洞扫描、恶意软件扫描
* 运行时安全：sidecar + buildkit

### 在线调试
当云效的流水线任务（例如构建、测试）执行失败后，系统不会立即清理和销毁执行该任务的Kubernetes Pod，而是将其暂时保留一段时间（例如1小时）。

用户可以在保留时间内，重新“连接”或“登陆”到这个被保留的容器环境中。可以像操作一台真实的服务器一样，在这个失败时的原始现场执行命令、查看日志、检查文件状态，从而精准地定位失败原因。

本地调整：在本机环境中，拉取云效流水线环境的镜像，模拟与Flow上相同的容器环境，并直接在本机中进行命令调试。

## 一些小特性
### 优势
* 页面可以看到最后一次执行的执行阶段，提供了一系列的构建模板，支持在过程中替换环境变量
* 提供修改配置文件步骤做变量替换、可通过写入.env做步骤间环境变量传递。任务间环境变量传递
* github等服务扩展点支持配置公钥认证
* 对于触发源的定义，flow认为只要是提供原料的，都可以作为触发源。可以是代码，也可以是构建产物做后续的测试和构建。同时支持制品仓hook作为触发源、支持jenkins为流水线源。
* 提交代码触发等会自动生成webhook，用户可以将webhook-url配置到触发源
* 提供了一系列的流水线报表和metric信息
* 私有构建集群的构建时长和并发任务数不计入企业构建配额
* 开发模式遵循github插件规则，语言为nodejs
* 支持移动端构建、安卓构建、微信小程序发布
* 使用maven-deploy-plugin和altDeploymentRepository，而不需要在pom文件中指定坐标

### 劣势
* 删除流水线没有回收站，无法恢复
* 不支持instruction as code 即无法读取代码仓中的yml文件，只能维护在线上

### 最佳实践

#### [cicd开发流程](https://help.aliyun.com/zh/yunxiao/user-guide/multi-environment-image-promotion-reuse-best-practices?spm=a2c4g.11186623.help-menu-150040.d_2_5_1_5_1.651816c9Ud1jh7)

开发在测试环境提交代码，并基于特性分支开发自验证。验证通过后，基于MR合入master，流水线自动触发部署预发。测试在预发做安全、性能和稳定性测试。

流水线源可以选择另一个流水线作为源（类似父子流水线），可直接引用上一个流水线最后一次构建（可选择）的产物。例如，生产发布可选用预发流水线的产物佐为流水线源发布。

#### [分支模式](https://help.aliyun.com/zh/yunxiao/user-guide/branch-mode?spm=a2c4g.11186623.help-menu-150040.d_2_5_7_0.694370fdIwyz80)

master代表最新发布版本、在feature分支上开发、release分支用于集成和发布。

每个环境都应该需要一个release分支，防止互相干扰和影响。当将集成成果从一个环境传递到下一个环境时，应基于 master 分支创建新的 release 分支，将前一个环境的 release 分支合并到新的 release 分支上。

新增一个分支管理器，分支管理器定义一个基础分支，可以增加多个运行时分支，每个分支都是特性分支。实际运行，会将所有的特性分支合并为release分支部署，自动完成公共分支代码合并。

通过分支管理器，支持在运行过程中进行代码合并，支持变量组，让不同的流水线关联一组或者多组变量

#### [SCRUM-业产技融合分层协作方案](https://help.aliyun.com/zh/yunxiao/use-cases/layered-collaboration-scheme-for-industry-industry-technology-integration?spm=a2c4g.11186623.help-menu-150040.d_3_1_9.f43a2cb7sDp7vB)

技术团队所做的需求，是否很好的支撑了公司的业务发展？产品演进的中长期规划是什么，现在所做的需求对于产品的发展是否具有价值？第一个问题如果回答的不好，就会出现技术团队很忙，效率也很高，但是仍然无法满足公司的业务发展，或者无法让业务团队感到满意。第二个问题如果回答的不好，就会出现产品技术团队每天在不断的接需求、做需求，功能在不断增加和堆叠，但是产品的竞争力却没有提高，时间长了对产品的演进危害很大。

源源不断的产品需求时，SCRUM可以帮助技术团队找到一个科学的工作节奏，通过一个接一个的迭代，持续交付需求，并且可以对研发过程中的问题进行快速的改进，在下一个迭代就能马上得到验证，这样不断的探索整个技术团队的极致工作效率。

而业产技分层协作模式，不仅仅关注研发交付过程，而是对业务、产品、技术三个团队的工作流程分别定义，再通过分层的方式，让三个团队的协作有机的融合在一起。在业产技的“技”这个领域，SCRUM其实是业产技方案中的一环，是技术团队的一种选择。

我们需知道，日常项目协作中的任务状态自动流转、需求自动指派、自动催办、平台集成等事情，完全可以通过简单的自动化规则设定完成

### AppStack
AppStack 和流水线 Flow 都是云效产品矩阵中的子产品。流水线 Flow 只能做部署，没有应用、环境、资源池的概念，AppStack 是对流水线持续部署（CD）能力的补充。流水线只能表达任务流程，多了以后只能分组管理，分类难规范，用 AppStack 中的应用概念囊括流水线、环境、资源等等信息，可以让研发管理更规范。